<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Room for Me and Her</title>
    <style>
        /* 保持原有样式，新增/修改环境音相关样式 */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #111;
            border: 1px solid #333;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border: 1px solid #555;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        ::-webkit-scrollbar-corner {
            background: #111;
        }

        .delete-song-btn {
            background: #ff6b6b !important;
            border: 1px solid #ff6b6b !important;
            padding: 2px 8px !important;
            font-size: 0.7rem !important;
            margin-left: auto;
        }

        .delete-song-btn:hover {
            background: #ff5252 !important;
            border-color: #ff5252 !important;
        }

        .panel::-webkit-scrollbar {
            width: 8px;
        }

        #playlist-panel::-webkit-scrollbar {
            width: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }

        body {
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            background-color: #000;
            color: #fff;
        }

        #background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease;
        }

        .container {
            display: flex;
            height: calc(100vh - 100px);
            width: 100vw;
        }

        .panel {
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.4);
            margin: 20px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
            max-width: 300px;
            overflow-y: auto;
        }

        #environment-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 2px solid #fff;
            padding: 25px;
            width: 1200px;
            max-width: 90vw;
            z-index: 9998;
        }

        #environment-panel.show {
            display: block;
        }

        /* 新增：环境音面板头部和多选提示 */
        .environment-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #555;
        }
        .environment-panel-header h3 {
            margin: 0;
            border: none;
            padding: 0;
        }
        .multi-select-hint {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 15px;
            text-align: center;
        }

        #environment-items-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        #close-environment {
            position: static; /* 修改：固定定位改为静态，适配头部布局 */
            width: 30px;
            height: 30px;
            padding: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #333;
            border: 1px solid #555;
            cursor: pointer;
        }
        #close-environment:hover {
            background: #555;
            border-color: #777;
        }

        /* 修改：环境音项样式，支持多选视觉反馈 */
        .environment-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            transition: all 0.3s ease;
            width: 100%; /* 修复宽度问题 */
            background-color: rgba(0, 0, 0, 0.6);
            aspect-ratio: 1;
            cursor: pointer; /* 整项可点击 */
        }
        .environment-item:hover {
            background-color: rgba(50, 50, 50, 0.8);
            border-color: #666;
        }
        .environment-item.active {
            background-color: rgba(80, 80, 120, 0.7); /* 选中背景色 */
            border-color: #99f; /* 选中边框色 */
        }

        .sound-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            width: 100%;
            justify-content: flex-start;
        }

        .env-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border: 2px solid #555;
            background: #222;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
            margin-right: 6px;
        }
        .env-checkbox:checked {
            background: #99f; /* 复选框选中背景 */
            border-color: #ccf;
        }
        .env-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-size: 12px;
            font-weight: bold;
        }
        .env-checkbox:focus {
            outline: none;
            border-color: #fff;
        }

        .env-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            flex-grow: 1;
        }

        .env-icon {
            width: 24px;
            height: 24px;
            object-fit: contain;
            margin-right: 6px;
            filter: brightness(0.8);
            transition: filter 0.3s ease;
        }

        .environment-item.active .env-icon {
            filter: brightness(1.2);
        }

        .env-name {
            font-size: 0.7rem; /* 放大名称，更易读 */
            color: #ddd;
            text-align: center;
            width: 100%;
            line-height: 1.3;
            margin-top: 5px;
            text-transform: none; /* 取消大写，更自然 */
        }

        .environment-item .volume-control span {
            display: none;
        }

        .environment-item .volume-control input {
            width: 100%;
            margin: 0;
        }

        .volume-control {
            display: flex;
            align-items: center;
            width: 100%;
            margin-top: 3px;
        }
        .volume-control input[type="range"] {
            flex-grow: 1;
            margin-right: 5px;
            height: 3px;
        }
        .volume-value {
            font-size: 0.6rem;
            color: #888;
            min-width: 25px;
            text-align: right;
        }

        #left-panel {
            display: flex;
            flex-direction: column;
            height:55%;
            gap: 20px;
        }

        .control-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            align-items: center;
            justify-content: center;
        }

        .control-buttons button {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        #middle-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 3rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            font-family: 'Times New Roman', serif;
        }

        #bottom-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height:125px;
            background-color: rgba(0, 0, 0, 0.9);
            border-top: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            z-index: 100;
            padding: 15px 20px;
        }

        .control-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
        }

        h3 {
            margin-bottom: 10px;
            color: #ccc;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #555;
            padding-bottom: 5px;
        }

        button {
            padding: 8px 15px;
            background-color: #222;
            color: #ccc;
            border: 1px solid #555;
            border-radius: 0;
            cursor: pointer;
            margin: 5px 0;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            background-color: #333;
            color: #fff;
            border-color: #777;
        }

        button:disabled {
            background-color: #111;
            color: #666;
            cursor: not-allowed;
        }

        input[type="number"] {
            width: 60px;
            padding: 5px;
            margin: 5px 0;
            background-color: #222;
            color: #fff;
            border: 1px solid #555;
        }

        .volume-control {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }

        .volume-control span {
            margin-right: 10px;
            width: 80px;
            color: #aaa;
        }

        input[type="range"] {
            width: 100%;
            background: #333;
            height: 5px;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            background: #ccc;
            border: 1px solid #555;
            cursor: pointer;
        }

        #music-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 15px;
            padding: 0 20px;
        }

        .center-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 500px;
            gap: 5px;
        }

        #song-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 5px;
            width: 100%;
        }

        #song-title {
            font-size: 1rem;
            color: #fff;
            text-align: center;
            font-weight: bold;
        }

        #song-progress-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 500px;
            margin: 10px 0;
            gap: 15px;
        }

        #song-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 400px;
            margin: 10px 0;
        }

        #progress-bar {
            flex: 1;
            height: 6px;
            background: #333;
            position: relative;
            cursor: pointer;
            border-radius: 3px;
            overflow: hidden;
        }

        #volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 120px;
        }

        #playlist-toggle {
            min-width: 100px;
        }

        #progress {
            position: absolute;
            height: 100%;
            background: #ccc;
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 3px;
        }

        #progress-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            left: 0%;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        #progress-bar:hover #progress-handle {
            opacity: 1;
        }

        #current-time, #total-time {
            font-size: 0.8rem;
            color: #888;
            min-width: 40px;
            font-family: 'Courier New', monospace;
        }

        #time-display {
            margin: 10px 0;
            font-size: 1.8rem;
            color: #fff;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        #playlist-panel {
            position: absolute;
            bottom: 120px;
            right: 20px;
            width: 300px;
            max-height: 250px;
            background-color: rgba(0, 0, 0, 0.9);
            border: 1px solid #555;
            padding: 10px 15px;
            display: none;
            z-index: 101;
            overflow-y: auto;
        }

        #playlist-panel h4 {
            margin-bottom: 10px;
            color: #ccc;
            border-bottom: 1px solid #555;
            padding-bottom: 3px;
        }

        #playlist-panel > div:first-child {
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }

        .playlist-item {
            padding: 4px 5px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            transition: background 0.2s;
        }

        .playlist-item:hover {
            background-color: #222;
        }

        .playlist-item.active {
            color: #fff;
            background-color: #333;
        }

        .song-duration {
            color: #888;
            font-size: 0.8rem;
        }

        .play-mode-btn {
            width: 35px;
            height: 35px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            background-color: #222;
            border: 1px solid #555;
            margin: 0 2px;
        }
        .play-mode-btn:hover {
            background-color: #333;
            border-color: #777;
        }
        .play-mode-btn.active {
            background-color: #444;
            border-color: #fff;
            color: #fff;
        }

        .mode-controls {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            justify-content: center;
        }

        .mode-controls .play-mode-btn {
            width: 35px;
            height: 35px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            background-color: #222;
            border: 1px solid #555;
            margin: 0 2px;
        }

        .mode-controls .play-mode-btn:hover {
            background-color: #333;
            border-color: #777;
        }

        .mode-controls .play-mode-btn.active {
            background-color: #444;
            border-color: #fff;
            color: #fff;
        }

        #customAlert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 2px solid #fff;
            padding: 25px 30px;
            width: 380px;
            max-width: 90vw;
            z-index: 9999;
            display: none;
        }

        #customAlert p {
            color: #fff;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 20px;
            text-align: center;
        }

        #customAlert button {
            display: block;
            margin: 0 auto;
            background: #333;
            color: #fff;
            border: 1px solid #fff;
            padding: 8px 20px;
        }

        #customAlert button:hover {
            background: #555;
        }

        #background-music {
            display: none;
        }

        #play-pause-btn.play::before {
            content: '';
            display: inline-block;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 0 8px 14px;
            border-color: transparent transparent transparent #fff;
        }

        #play-pause-btn.pause::before {
            content: '';
            display: inline-block;
            width: 14px;
            height: 16px;
            background: linear-gradient(to right, #fff 35%, transparent 35%, transparent 65%, #fff 65%);
        }

        #prev-song {
            position: relative;
            width: 40px;
            height: 40px;
            padding: 0;
        }
        #prev-song::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 12px 8px 0;
            border-color: transparent #fff transparent transparent;
            margin-left: -6px;
        }
        #prev-song::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 12px 8px 0;
            border-color: transparent #fff transparent transparent;
            margin-left: 2px;
        }

        #next-song {
            position: relative;
            width: 40px;
            height: 40px;
            padding: 0;
        }
        #next-song::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 0 8px 12px;
            border-color: transparent transparent transparent #fff;
            margin-left: -2px;
        }
        #next-song::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 0 8px 12px;
            border-color: transparent transparent transparent #fff;
            margin-left: 6px;
        }
    </style>
</head>
<body>
    <div id="background"></div>

    <div id="customAlert">
        <p>Please manually select a song and environment sound to play.</p>
        <button id="closeAlert">Close</button>
    </div>

    <audio id="background-music"></audio>

    <div class="container">
        <div id="left-panel" class="panel">
            <div class="control-section">
                <h3>concentration setting</h3>
                <div>
                    <label>Focus Times(minutes):</label>
                    <input type="number" id="focus-time" min="1" max="60" value="25">
                </div>
                <div>
                    <label>Resting Times(minutes):</label>
                    <input type="number" id="break-time" min="1" max="30" value="5">
                </div>
                <div id="time-display">25:00</div>
                <button id="start-focus">Start Focusing</button>
                <button id="pause-focus" disabled>Pause Focusing</button>
                <button id="stop-focus" disabled>Complete Focusing</button>
            </div>

            <div class="control-section">
                <button id="toggle-environment">Background Sounds</button>
                <!-- 修改：环境音面板结构，添加头部和多选提示 -->
                <div id="environment-panel" class="environment-panel">
                    <div class="environment-panel-header">
                        <h3>Background Sounds (Select Multiple)</h3>
                        <button id="close-environment">×</button>
                    </div>
                    <p class="multi-select-hint">Check multiple options to mix sounds (e.g., rain + fireplace)</p>
                    <div id="environment-items-container"></div>
                </div>
            </div>
        </div>

        <div id="middle-area"></div>
    </div>

    <div id="bottom-panel">
        <div id="music-controls">
            <div id="volume-control">
                <span>Volume:</span>
                <input type="range" id="music-volume" min="0" max="100" value="50">
            </div>

            <div class="center-controls">
                <div id="song-info">
                    <div id="song-title">Select a song to play</div>
                </div>

                <div id="song-progress-container">
                    <div id="song-progress">
                        <span id="current-time">0:00</span>
                        <div id="progress-bar">
                            <div id="progress"></div>
                            <div id="progress-handle"></div>
                        </div>
                        <span id="total-time">0:00</span>
                    </div>

                    <div class="mode-controls">
                        <button id="play-mode-order" title="Play in order" class="play-mode-btn active">⇄</button>
                        <button id="play-mode-loop" title="Loop playback" class="play-mode-btn">↻</button>
                        <button id="play-mode-random" title="Shuffle play" class="play-mode-btn">⇢</button>
                    </div>
                </div>

                <div class="control-buttons">
                    <button id="prev-song" title="Previous"></button>
                    <button id="play-pause-btn" title="Play" class="play"></button>
                    <button id="next-song" title="Next"></button>
                </div>
            </div>

            <button id="playlist-toggle">playlist</button>
        </div>
    </div>

    <div id="playlist-panel">
        <h4>playlists</h4>
        <div style="margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;">
            <button id="upload-song-btn" style="width: 100%; margin-bottom: 10px;">Upload Local Song</button>
            <input type="file" id="file-input" accept="audio/*" style="display: none;">
            <div id="upload-status" style="font-size: 0.8rem; color: #888; text-align: center;"></div>
        </div>
        <div id="playlist-items"></div>
    </div>

    <script>
        const state = {
            playMode: 'order',
            isFocusing: false,
            isPaused: false,
            focusTime: 25 * 60,
            breakTime: 5 * 60,
            currentTime: 0,
            timerInterval: null,
            environmentSounds: [],
            selectedSong: null,
            currentSongIndex: 0,
            isMusicPlaying: false,
            currentSongType: 'default',
            songOptions: [
                { id: 'song1', title: 'Dream Dancer', duration: '4:07', src: 'music/Dream_Dancer.mp3' },
                { id: 'song2', title: 'Dark Music Box Waltz', duration: '2:48', src: 'music/Dark_Music_Box_Waltz.mp3' },
                { id: 'song3', title: 'Emotional Waltz', duration: '2:15', src: 'music/Emotional_Waltz.mp3' },
                { id: 'song4', title: "The Vampire's Ball", duration: '3:16', src: 'music/The_Vampire_s_Ball.mp3' },
                { id: 'song5', title: 'The_Goddess_Of_Tears_Legend', duration: '3:02', src: 'music/The_Goddess_Of Tears～Legend～.mp3' },
                { id: 'song6', title: 'Ghost Waltz', duration: '2:08', src: 'music/Ghost_Waltz.mp3' },
                { id: 'song7', title: 'Secret Garden', duration: '3:18', src: 'music/Secret_Garden.mp3' },
                { id: 'song8', title: 'Spirit Of The Woods', duration: '5:00', src: 'music/Spirit_Of_The_Woods.mp3' },
                { id: 'song9', title: 'Patchwork_Staccato', duration: '4:18', src: 'music/Patchwork_Staccato.mp3' },
                { id: 'song10', title: 'green_to_blue', duration: '3:08', src: 'music/green_to_blue.mp3' },
                { id: 'song11', title: 'When_You_re_In_Love', duration: '7:20', src: 'music/When_You_re_In_Love.mp3' },
                { id: 'song12', title: 'i_m_tired_of_feeling_this_way', duration: '2:32', src: 'music/i_m_tired_of_feeling_this_way.mp3' },
                { id: 'song13', title: 'toki', duration: '1:48', src: 'music/toki.mp3' },
                { id: 'song14', title: 'leave_the_garden_lights_on_(demo)', duration: '1:42', src: 'music/leave_the_garden_lights_on_(demo).mp3' },
                { id: 'song15', title: 'BlueBerry_Room', duration: '1:44', src: 'music/BlueBerry_Room.mp3' },
                { id: 'song16', title: 'Agnes_Obel', duration: '4:18', src: 'music/Agnes_Obel.mp3' },
                { id: 'song17', title: 'ポルターガイスト', duration: '4:18', src: 'music/ポルターガイスト.mp3' },
                { id: 'song18', title: "The Mystic's Dream", duration: '7:51', src: 'music/The_Mystics_Dream.mp3' }
            ],
            // 优化：简化环境音名称，更易识别
            environmentSoundOptions: [
                { id: 'The_fireplace_s_burn_from_kindling_to_embers', name: 'Fireplace Burn', volume: 50, audio: null, icon: '🔥' },
                { id: 'The_rain-lashed_forest', name: 'Rainy Forest', volume: 50, audio: null, icon: '🌧️' },
                { id: 'Autumnal_wind_crisp_fallen_leaves_and_avian_murmurs', name: 'Autumn Wind', volume: 50, audio: null, icon: '🍂' },
                { id: 'Gentle_wave_murmurs', name: 'Gentle Waves', volume: 50, audio: null, icon: '🌊' },
                { id: 'Wind_chimes_in_the_gentle_breeze', name: 'Wind Chimes', volume: 50, audio: null, icon: '🎐' },
                { id: 'writing_sounds', name: 'Writing Sounds', volume: 50, audio: null, icon: '✍️' },
                { id: 'drawing_sounds', name: 'Drawing Sounds', volume: 50, audio: null, icon: '🎨' },
            ],
            localSongs: [],
            localStorageKey: 'studyRoomLocalSongs'
        };

        const elements = {
            background: document.getElementById('background'),
            focusTimeInput: document.getElementById('focus-time'),
            breakTimeInput: document.getElementById('break-time'),
            timeDisplay: document.getElementById('time-display'),
            startFocusBtn: document.getElementById('start-focus'),
            pauseFocusBtn: document.getElementById('pause-focus'),
            stopFocusBtn: document.getElementById('stop-focus'),
            toggleEnvironmentBtn: document.getElementById('toggle-environment'),
            environmentPanel: document.getElementById('environment-panel'),
            nowPlaying: document.getElementById('now-playing'),
            musicVolume: document.getElementById('music-volume'),
            audioElement: document.getElementById('background-music'),
            middleArea: document.getElementById('middle-area'),
            prevSongBtn: document.getElementById('prev-song'),
            nextSongBtn: document.getElementById('next-song'),
            songTitle: document.getElementById('song-title'),
            currentTime: document.getElementById('current-time'),
            totalTime: document.getElementById('total-time'),
            progressBar: document.getElementById('progress-bar'),
            progress: document.getElementById('progress'),
            playlistToggle: document.getElementById('playlist-toggle'),
            playlistPanel: document.getElementById('playlist-panel'),
            playlistItems: document.getElementById('playlist-items'),
            playPauseBtn: document.getElementById('play-pause-btn'),
            customAlert: document.getElementById('customAlert'),
            closeAlert: document.getElementById('closeAlert'),
            environmentItemsContainer: document.getElementById('environment-items-container'),
            closeEnvironmentBtn: document.getElementById('close-environment')
        };

        function switchPlayMode(mode) {
            state.playMode = mode;
            updatePlayModeButtons();
        }

        function updatePlayModeButtons() {
            const orderBtn = document.getElementById('play-mode-order');
            const loopBtn = document.getElementById('play-mode-loop');
            const randomBtn = document.getElementById('play-mode-random');

            orderBtn.classList.remove('active');
            loopBtn.classList.remove('active');
            randomBtn.classList.remove('active');

            if (state.playMode === 'order') {
                orderBtn.classList.add('active');
            } else if (state.playMode === 'loop') {
                loopBtn.classList.add('active');
            } else if (state.playMode === 'random') {
                randomBtn.classList.add('active');
            }
        }

        function showBlackWhiteAlert(message = "Please manually select a song and environment sound to play.") {
            elements.customAlert.querySelector('p').textContent = message;
            elements.customAlert.style.display = 'block';
        }

        function closeBlackWhiteAlert() {
            elements.customAlert.style.display = 'none';
        }

        function toggleEnvironmentPanel() {
            elements.environmentPanel.classList.toggle('show');
        }

        function saveLocalSongs() {
            try {
                localStorage.setItem(state.localStorageKey, JSON.stringify(state.localSongs));
                console.log('Local songs saved:', state.localSongs);
            } catch (error) {
                console.error('Failed to save local songs:', error);
                showBlackWhiteAlert('Save failed: ' + error.message);
            }
        }

        function loadLocalSongs() {
            try {
                const saved = localStorage.getItem(state.localStorageKey);
                if (saved) {
                    state.localSongs = JSON.parse(saved);
                    console.log('Local songs loaded:', state.localSongs);
                }
            } catch (error) {
                console.error('Failed to load local songs:', error);
                state.localSongs = [];
            }
        }

        function initUploadFeature() {
            const uploadBtn = document.getElementById('upload-song-btn');
            const fileInput = document.getElementById('file-input');
            const uploadStatus = document.getElementById('upload-status');

            uploadBtn.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', handleFileUpload);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            const uploadStatus = document.getElementById('upload-status');

            if (!file) return;

            if (!file.type.startsWith('audio/')) {
                uploadStatus.textContent = 'Error: Please select an audio file';
                uploadStatus.style.color = '#ff6b6b';
                return;
            }

            if (file.size > 20 * 1024 * 1024) {
                uploadStatus.textContent = 'Error: File size must not exceed 20 MB.';
                uploadStatus.style.color = '#ff6b6b';
                return;
            }

            uploadStatus.textContent = 'Uploading...';
            uploadStatus.style.color = '#888';

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const songData = {
                        id: 'local_' + Date.now(),
                        title: file.name.replace(/\.[^/.]+$/, ""),
                        duration: 'Unknown',
                        src: e.target.result,
                        isLocal: true,
                        fileName: file.name
                    };

                    state.localSongs.push(songData);
                    saveLocalSongs();
                    updatePlaylistForCurrentSong(state.currentSongIndex);

                    uploadStatus.textContent = 'Upload successful!';
                    uploadStatus.style.color = '#6bff6b';

                    setTimeout(() => {
                        uploadStatus.textContent = '';
                    }, 3000);

                } catch (error) {
                    console.error('Failed to process uploaded file:', error);
                    uploadStatus.textContent = 'Upload failed: ' + error.message;
                    uploadStatus.style.color = '#ff6b6b';
                }
            };

            reader.onerror = function() {
                uploadStatus.textContent = 'Failed to read the file';
                uploadStatus.style.color = '#ff6b6b';
            };

            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function deleteLocalSong(songId) {
            if (confirm('Are you sure you want to delete this song?')) {
                state.localSongs = state.localSongs.filter(song => song.id !== songId);
                saveLocalSongs();

                if (state.selectedSong && state.selectedSong.id === songId) {
                    elements.audioElement.pause();
                    elements.audioElement.src = '';
                    state.isMusicPlaying = false;
                    updatePlayPauseButton();
                    elements.songTitle.textContent = 'Select a song to play';
                }

                updatePlaylistForCurrentSong(state.currentSongIndex);
            }
        }

        function autoPlayNextSong() {
            elements.songTitle.textContent = 'Select a song to play';
        }

        function initPlaylist() {
            loadLocalSongs();
            const playlist = elements.playlistItems;
            playlist.innerHTML = '';
            const allSongs = [...state.songOptions, ...state.localSongs];
            let displaySongs;
            
            if (state.playMode === 'random') {
                displaySongs = allSongs.sort(() => Math.random() - 0.5);
            } else {
                displaySongs = [...allSongs];
            }
            
            displaySongs.forEach((song, index) => {
                const item = createPlaylistItem(song, index);
                playlist.appendChild(item);
            });
            
            return displaySongs;
        }

        function createPlaylistItem(song, index) {
            const item = document.createElement('div');
            item.className = 'playlist-item';
            item.dataset.index = index;

            const deleteBtn = song.isLocal ?
                `<button class="delete-song-btn" data-song-id="${song.id}" style="margin-left: auto; background: #ff6b6b; border: 1px solid #ff6b6b; padding: 2px 8px; font-size: 0.7rem;">Delete</button>` :
                '';

            item.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                    <div style="display: flex; flex-direction: column;">
                        <span>${song.title}</span>
                        ${song.isLocal ? '<span style="font-size: 0.7rem; color: #6bff6b;">[Local]</span>' : ''}
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="song-duration">${song.duration}</span>
                        ${deleteBtn}
                    </div>
                </div>
            `;

            item.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-song-btn')) {
                    return;
                }
                playSong(index);
            });

            if (song.isLocal) {
                const deleteBtn = item.querySelector('.delete-song-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteLocalSong(song.id);
                });
            }

            return item;
        }

        function updatePlaylistForCurrentSong(currentIndex) {
            const playlist = elements.playlistItems;
            playlist.innerHTML = '';
            const allSongs = [...state.songOptions, ...state.localSongs];
            let displaySongs;
            
            if (state.playMode === 'random') {
                displaySongs = allSongs.sort(() => Math.random() - 0.5);
            } else {
                displaySongs = [...allSongs];
            }
            
            displaySongs.forEach((song, index) => {
                const item = createPlaylistItem(song, index);
                if (song.id === allSongs[currentIndex]?.id) {
                    item.classList.add('active');
                }
                playlist.appendChild(item);
            });
            
            return displaySongs;
        }

        let isLoadingAudio = false;

        async function playSong(index) {
            if (isLoadingAudio) {
                elements.audioElement.pause();
                elements.audioElement.src = '';
                isLoadingAudio = false;
            }

            const allSongs = [...state.songOptions, ...state.localSongs];
            if (!allSongs[index] || !allSongs[index].src) {
                showBlackWhiteAlert('Invalid song path, please check the file.');
                return;
            }

            isLoadingAudio = true;
            const song = allSongs[index];
            state.currentSongIndex = index;
            state.currentSongType = song.isLocal ? 'local' : 'default';
            elements.songTitle.textContent = song.title + (song.isLocal ? ' [Local Music]' : '');
            updatePlaylistForCurrentSong(index);

            elements.progress.style.width = '0%';
            elements.currentTime.textContent = '0:00';

            try {
                elements.audioElement.pause();
                elements.audioElement.removeEventListener('timeupdate', updateProgress);
                elements.audioElement.removeEventListener('loadedmetadata', handleLoadedMetadata);
                elements.audioElement.removeEventListener('ended', handleAudioEnded);

                elements.audioElement.src = song.src;
                elements.audioElement.volume = elements.musicVolume.value / 100;

                elements.audioElement.addEventListener('loadedmetadata', handleLoadedMetadata);
                elements.audioElement.addEventListener('ended', handleAudioEnded);

                state.isMusicPlaying = false;
                updatePlayPauseButton();
                isLoadingAudio = false;

            } catch (error) {
                console.error('Playback initialization failed:', error);
                showBlackWhiteAlert('Failed to initialize playback. Please select the song again.');
                state.isMusicPlaying = false;
                updatePlayPauseButton();
                isLoadingAudio = false;
            }
        }

        function handleLoadedMetadata() {
            if (elements.audioElement.duration && !isNaN(elements.audioElement.duration)) {
                elements.totalTime.textContent = formatTime(elements.audioElement.duration);
                updateProgress();
            }
            elements.audioElement.addEventListener('timeupdate', updateProgress);
        }

        function handleAudioEnded() {
            state.isMusicPlaying = false;
            updatePlayPauseButton();
            elements.songTitle.textContent = 'Song ended. Select another song';
        }

        function setupAudioEvents() {
        }

        async function togglePlayPause() {
            if (!elements.audioElement.src) {
                showBlackWhiteAlert('Please select a song first from the playlist');
                return;
            }

            if (state.isMusicPlaying) {
                pauseMusic();
            } else {
                await playMusic();
            }
        }

        async function playMusic() {
            if (!elements.audioElement.src) {
                showBlackWhiteAlert('Please select a song first from the playlist');
                return;
            }

            try {
                await elements.audioElement.play();
                state.isMusicPlaying = true;
                updatePlayPauseButton();
            } catch (error) {
                console.error('Playback failed:', error);
                showBlackWhiteAlert('Playback failed. Please try selecting the song again.');
            }
        }

        function pauseMusic() {
            elements.audioElement.pause();
            state.isMusicPlaying = false;
            updatePlayPauseButton();
        }

        function updatePlayPauseButton() {
            const btn = elements.playPauseBtn;
            if (state.isMusicPlaying) {
                btn.className = 'pause';
                btn.title = 'Pause';
            } else {
                btn.className = 'play';
                btn.title = 'Play';
            }
        }

        function playPreviousSong() {
            const allSongs = [...state.songOptions, ...state.localSongs];
            if (allSongs.length === 0) return;

            let prevIndex;
            switch (state.playMode) {
                case 'order':
                    prevIndex = state.currentSongIndex - 1;
                    if (prevIndex < 0) {
                        showBlackWhiteAlert('This is the first song');
                        return;
                    }
                    break;
                case 'loop':
                    prevIndex = state.currentSongIndex - 1;
                    if (prevIndex < 0) prevIndex = allSongs.length - 1;
                    break;
                case 'random':
                    prevIndex = Math.floor(Math.random() * allSongs.length);
                    break;
                default:
                    prevIndex = state.currentSongIndex - 1;
                    if (prevIndex < 0) prevIndex = allSongs.length - 1;
            }

            playSong(prevIndex);
        }

        function playNextSong() {
            const allSongs = [...state.songOptions, ...state.localSongs];
            if (allSongs.length === 0) return;

            let nextIndex;
            switch (state.playMode) {
                case 'order':
                    nextIndex = state.currentSongIndex + 1;
                    if (nextIndex >= allSongs.length) {
                        showBlackWhiteAlert('This is the last song');
                        return;
                    }
                    break;
                case 'loop':
                    nextIndex = (state.currentSongIndex + 1) % allSongs.length;
                    break;
                case 'random':
                    nextIndex = Math.floor(Math.random() * allSongs.length);
                    break;
                default:
                    nextIndex = state.currentSongIndex + 1;
            }

            playSong(nextIndex);
        }

        function updateProgress() {
            if (elements.audioElement.duration && !isNaN(elements.audioElement.duration)) {
                const currentTime = elements.audioElement.currentTime;
                const duration = elements.audioElement.duration;
                const progressPercent = (currentTime / duration) * 100;

                elements.progress.style.width = `${progressPercent}%`;
                const progressHandle = document.getElementById('progress-handle');
                if (progressHandle) {
                    progressHandle.style.left = `${progressPercent}%`;
                }

                elements.currentTime.textContent = formatTime(currentTime);
                elements.totalTime.textContent = formatTime(duration);
            }
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return "0:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function setupProgressBarClick() {
            elements.progressBar.addEventListener('click', (e) => {
                if (elements.audioElement.duration) {
                    const clickPosition = e.offsetX / elements.progressBar.offsetWidth;
                    const newTime = clickPosition * elements.audioElement.duration;
                    elements.audioElement.currentTime = newTime;
                    updateProgress();
                }
            });
        }

        function setupProgressBarDrag() {
            let isDragging = false;

            elements.progressBar.addEventListener('mousedown', (e) => {
                isDragging = true;
                handleProgressBarClick(e);
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const rect = elements.progressBar.getBoundingClientRect();
                    const clickPosition = (e.clientX - rect.left) / rect.width;
                    const newTime = Math.max(0, Math.min(1, clickPosition)) * elements.audioElement.duration;
                    elements.audioElement.currentTime = newTime;
                    updateProgress();
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        }

        function handleProgressBarClick(e) {
            if (elements.audioElement.duration) {
                const rect = elements.progressBar.getBoundingClientRect();
                const clickPosition = (e.clientX - rect.left) / rect.width;
                const newTime = Math.max(0, Math.min(1, clickPosition)) * elements.audioElement.duration;
                elements.audioElement.currentTime = newTime;
                updateProgress();
            }
        }

        function setBackground(mode) {
            const gifUrls = {
                focus: 'images/studying.gif',
                rest: 'images/resting.gif'
            };
            elements.background.style.backgroundImage = `url(${gifUrls[mode]})`;
        }

        // 核心修改：初始化环境音面板，支持多选
        function initEnvironmentPanel() {
            const container = elements.environmentItemsContainer;
            container.innerHTML = '';

            state.environmentSoundOptions.forEach(sound => {
                const soundElement = document.createElement('div');
                soundElement.className = 'environment-item';
                soundElement.dataset.soundId = sound.id;

                // 新增：点击整个环境音项切换选中状态
                soundElement.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('env-volume')) {
                        const checkbox = soundElement.querySelector('.env-checkbox');
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });

                soundElement.innerHTML = `
                    <div class="sound-header">
                        <input type="checkbox" class="env-checkbox" id="env-${sound.id}">
                        <label for="env-${sound.id}" class="env-label">
                            <span class="env-icon">${sound.icon}</span> <!-- 修改：用emoji替代图片，避免路径问题 -->
                            <span class="env-name">${sound.name}</span>
                        </label>
                    </div>
                    <div class="volume-control">
                        <input type="range" class="env-volume" data-sound="${sound.id}" min="0" max="100" value="${sound.volume}">
                        <span class="volume-value">${sound.volume}%</span>
                    </div>
                `;
                container.appendChild(soundElement);

                // 初始化独立音频对象（支持多音轨同时播放）
                sound.audio = new Audio(`sounds/${sound.id}.mp3`);
                sound.audio.loop = true;
                sound.audio.volume = sound.volume / 100;

                sound.audio.addEventListener('error', function(e) {
                    console.error(`Environment sound load failed: ${sound.name}`, e);
                    showBlackWhiteAlert(`Environment sound failed to load: ${sound.name}. Please check the "sounds" folder.`);
                });

                // 复选框切换事件（多选核心逻辑）
                const checkbox = soundElement.querySelector('.env-checkbox');
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        // 选中：播放当前环境音，不影响其他已选中的
                        playEnvironmentSound(sound);
                        soundElement.classList.add('active');
                    } else {
                        // 取消：停止当前环境音，不影响其他
                        stopEnvironmentSound(sound);
                        soundElement.classList.remove('active');
                    }
                });

                // 独立音量控制
                const volumeSlider = soundElement.querySelector('.env-volume');
                const volumeValue = soundElement.querySelector('.volume-value');
                volumeSlider.addEventListener('input', (e) => {
                    sound.volume = e.target.value;
                    volumeValue.textContent = `${sound.volume}%`;
                    if (sound.audio) {
                        sound.audio.volume = sound.volume / 100;
                    }
                });
            });
        }

        // 播放环境音（支持多音轨同时播放）
        function playEnvironmentSound(sound) {
            if (sound.audio) {
                // 已播放时重置到开头，避免重复实例
                if (!sound.audio.paused) {
                    sound.audio.currentTime = 0;
                } else {
                    // 处理浏览器自动播放限制
                    sound.audio.play().catch(e => {
                        console.warn(`Auto-play blocked for ${sound.name}`, e);
                        showBlackWhiteAlert(`Click "Play" again to enable "${sound.name}" (browser policy).`);
                    });
                }
            }
        }

        // 停止环境音
        function stopEnvironmentSound(sound) {
            if (sound.audio) {
                sound.audio.pause();
                sound.audio.currentTime = 0;
            }
        }

        function startFocus() {
            if (state.isFocusing && !state.isPaused) return;

            state.isFocusing = true;
            state.isPaused = false;
            state.focusTime = parseInt(elements.focusTimeInput.value) * 60;
            state.breakTime = parseInt(elements.breakTimeInput.value) * 60;
            state.currentTime = state.focusTime;

            updateTimeDisplay();
            setBackground('focus');
            elements.startFocusBtn.disabled = true;
            elements.pauseFocusBtn.disabled = false;
            elements.stopFocusBtn.disabled = false;
            elements.pauseFocusBtn.textContent = 'Pause Focus';

            if (state.timerInterval) {
                clearInterval(state.timerInterval);
            }

            state.timerInterval = setInterval(() => {
                updateTimer();
            }, 1000);
        }

        function pauseFocus() {
            if (!state.isFocusing || state.isPaused) return;

            state.isPaused = true;
            clearInterval(state.timerInterval);
            elements.pauseFocusBtn.textContent = 'Continue Focus';
        }

        function resumeFocus() {
            if (!state.isFocusing || !state.isPaused) return;

            state.isPaused = false;
            state.timerInterval = setInterval(() => {
                updateTimer();
            }, 1000);
            elements.pauseFocusBtn.textContent = 'Pause Focus';
        }

        function stopFocus() {
            state.isFocusing = false;
            state.isPaused = false;
            clearInterval(state.timerInterval);
            setBackground('rest');
            elements.startFocusBtn.disabled = false;
            elements.pauseFocusBtn.disabled = true;
            elements.stopFocusBtn.disabled = true;
            elements.pauseFocusBtn.textContent = 'Pause Focus';
            const focusMinutes = parseInt(elements.focusTimeInput.value);
            elements.timeDisplay.textContent = `${focusMinutes.toString().padStart(2, '0')}:00`;
        }

        function updateTimer() {
            if (state.isPaused) return;

            if (state.currentTime <= 0) {
                if (state.isFocusing) {
                    state.isFocusing = false;
                    state.currentTime = state.breakTime;
                    setBackground('rest');
                    showBlackWhiteAlert('Focus session complete—time for a break.');
                } else {
                    stopFocus();
                    showBlackWhiteAlert('Break time is over.');
                }
                return;
            }

            state.currentTime--;
            updateTimeDisplay();
        }

        function updateTimeDisplay() {
            const minutes = Math.floor(state.currentTime / 60);
            const seconds = state.currentTime % 60;
            elements.timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function initEventListeners() {
            elements.startFocusBtn.addEventListener('click', startFocus);
            elements.pauseFocusBtn.addEventListener('click', () => {
                if (state.isPaused) {
                    resumeFocus();
                } else {
                    pauseFocus();
                }
            });
            elements.stopFocusBtn.addEventListener('click', stopFocus);

            elements.toggleEnvironmentBtn.addEventListener('click', () => {
                elements.environmentPanel.classList.toggle('show');
            });

            elements.closeEnvironmentBtn.addEventListener('click', () => {
                elements.environmentPanel.classList.remove('show');
            });

            elements.environmentPanel.addEventListener('click', (e) => {
                if (e.target === elements.environmentPanel) {
                    elements.environmentPanel.classList.remove('show');
                }
            });

            document.getElementById('play-mode-order').addEventListener('click', () => {
                switchPlayMode('order');
            });

            document.getElementById('play-mode-loop').addEventListener('click', () => {
                switchPlayMode('loop');
            });

            document.getElementById('play-mode-random').addEventListener('click', () => {
                switchPlayMode('random');
            });

            elements.playPauseBtn.addEventListener('click', togglePlayPause);
            elements.prevSongBtn.addEventListener('click', playPreviousSong);
            elements.nextSongBtn.addEventListener('click', playNextSong);

            elements.musicVolume.addEventListener('input', () => {
                elements.audioElement.volume = elements.musicVolume.value / 100;
            });

            elements.progressBar.addEventListener('click', (e) => {
                if (elements.audioElement.duration) {
                    const clickPosition = e.offsetX / elements.progressBar.offsetWidth;
                    elements.audioElement.currentTime = clickPosition * elements.audioElement.duration;
                }
            });

            elements.playlistToggle.addEventListener('click', () => {
                elements.playlistPanel.style.display =
                    elements.playlistPanel.style.display === 'block' ? 'none' : 'block';
            });

            elements.closeAlert.addEventListener('click', closeBlackWhiteAlert);
            elements.customAlert.addEventListener('click', (e) => {
                if (e.target === elements.customAlert) {
                    closeBlackWhiteAlert();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space') {
                    e.preventDefault();
                    togglePlayPause();
                } else if (e.code === 'ArrowLeft') {
                    e.preventDefault();
                    playPreviousSong();
                } else if (e.code === 'ArrowRight') {
                    e.preventDefault();
                    playNextSong();
                } else if (e.code === 'Escape') {
                    elements.environmentPanel.classList.remove('show');
                    elements.playlistPanel.style.display = 'none';
                    closeBlackWhiteAlert();
                }
            });

            document.addEventListener('dragstart', (e) => {
                e.preventDefault();
            });

            window.addEventListener('resize', () => {
                console.log('Window resized:', window.innerWidth, 'x', window.innerHeight);
            });
        }

        async function init() {
            setBackground('rest');
            initEnvironmentPanel();
            initEventListeners();
            initUploadFeature();
            loadLocalSongs();

            updatePlayModeButtons();
            const displaySongs = initPlaylist();
            setupProgressBarClick();
            showBlackWhiteAlert("Please manually select a song and environment sound to play.");
        }

        elements.closeAlert.addEventListener('click', closeBlackWhiteAlert);
        window.addEventListener('load', init);
    </script>
</body>
</html>
