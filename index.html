<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Room for Me and Her</title>
    <style>
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        ::-webkit-scrollbar-track {
            background: #111;
            border: 1px solid #333;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border: 1px solid #555;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }
        ::-webkit-scrollbar-corner {
            background: #111;
        }
        .panel::-webkit-scrollbar { width: 8px; }
        #playlist-panel::-webkit-scrollbar { width: 8px; }

        /* å…¨å±€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        body {
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            background-color: #000;
            color: #fff;
        }

        /* èƒŒæ™¯å›¾ */
        #background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease;
        }

        /* å®¹å™¨å¸ƒå±€ */
        .container {
            display: flex;
            height: calc(100vh - 100px);
            width: 100vw;
        }
        .panel {
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.4);
            margin: 20px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
            max-width: 300px;
            overflow-y: auto;
        }
        #left-panel {
            display: flex;
            flex-direction: column;
            height: 55%;
            gap: 20px;
        }

        /* ç¯å¢ƒéŸ³é¢æ¿ï¼ˆæ”¯æŒå¤šé€‰ï¼‰ */
        #environment-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 2px solid #fff;
            padding: 25px;
            width: 1200px;
            max-width: 90vw;
            z-index: 9998;
        }
        #environment-panel.show { display: block; }
        .environment-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #555;
        }
        .environment-panel-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: none;
            padding: 0;
        }
        .multi-select-hint {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 15px;
            text-align: center;
        }
        #environment-items-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        #close-environment {
            position: static;
            width: 30px;
            height: 30px;
            padding: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #333;
            border: 1px solid #555;
            cursor: pointer;
        }
        #close-environment:hover {
            background: #555;
            border-color: #777;
        }

        /* ç¯å¢ƒéŸ³é¡¹æ ·å¼ */
        .environment-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            transition: all 0.3s ease;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            aspect-ratio: 1;
            cursor: pointer;
        }
        .environment-item:hover {
            background-color: rgba(50, 50, 50, 0.8);
            border-color: #666;
        }
        .environment-item.active {
            background-color: rgba(80, 80, 120, 0.7);
            border-color: #99f;
        }
        .sound-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            width: 100%;
            justify-content: flex-start;
        }
        .env-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border: 2px solid #555;
            background: #222;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
            margin-right: 6px;
        }
        .env-checkbox:checked {
            background: #99f;
            border-color: #ccf;
        }
        .env-checkbox:checked::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-size: 12px;
            font-weight: bold;
        }
        .env-checkbox:focus {
            outline: none;
            border-color: #fff;
        }
        .env-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            flex-grow: 1;
        }
        .env-icon {
            font-size: 24px;
            margin-right: 6px;
            transition: filter 0.3s ease;
        }
        .environment-item.active .env-icon {
            filter: brightness(1.2);
        }
        .env-name {
            font-size: 0.7rem;
            color: #ddd;
            text-align: center;
            margin-top: 5px;
            line-height: 1.3;
            width: 100%;
        }

        /* éŸ³é‡æ§åˆ¶ */
        .volume-control {
            display: flex;
            align-items: center;
            width: 100%;
            margin-top: 3px;
        }
        .volume-control input[type="range"] {
            flex-grow: 1;
            margin-right: 5px;
            height: 3px;
        }
        .volume-value {
            font-size: 0.6rem;
            color: #888;
            min-width: 25px;
            text-align: right;
        }
        .environment-item .volume-control input {
            width: 100%;
            margin: 0;
        }

        /* æ§åˆ¶æŒ‰é’®ç»„ */
        .control-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            align-items: center;
            justify-content: center;
        }
        .control-buttons button {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        /* ä¸­é—´åŒºåŸŸ */
        #middle-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 3rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            font-family: 'Times New Roman', serif;
        }

        /* åº•éƒ¨æ’­æ”¾æ§åˆ¶æ  */
        #bottom-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 125px;
            background-color: rgba(0, 0, 0, 0.9);
            border-top: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            z-index: 100;
            padding: 15px 20px;
        }
        .control-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
        }
        h3 {
            margin-bottom: 10px;
            color: #ccc;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #555;
            padding-bottom: 5px;
        }
        button {
            padding: 8px 15px;
            background-color: #222;
            color: #ccc;
            border: 1px solid #555;
            border-radius: 0;
            cursor: pointer;
            margin: 5px 0;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        button:hover {
            background-color: #333;
            color: #fff;
            border-color: #777;
        }
        button:disabled {
            background-color: #111;
            color: #666;
            cursor: not-allowed;
        }
        input[type="number"] {
            width: 60px;
            padding: 5px;
            margin: 5px 0;
            background-color: #222;
            color: #fff;
            border: 1px solid #555;
        }
        input[type="range"] {
            width: 100%;
            background: #333;
            height: 5px;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            background: #ccc;
            border: 1px solid #555;
            cursor: pointer;
        }

        /* éŸ³ä¹æ§åˆ¶åŒº */
        #music-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 15px;
            padding: 0 20px;
        }
        .center-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 500px;
            gap: 5px;
        }
        #song-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 5px;
            width: 100%;
        }
        #song-title {
            font-size: 1rem;
            color: #fff;
            text-align: center;
            font-weight: bold;
        }
        #song-progress-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 500px;
            margin: 10px 0;
            gap: 15px;
        }
        #song-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 400px;
            margin: 10px 0;
        }
        #progress-bar {
            flex: 1;
            height: 6px;
            background: #333;
            position: relative;
            cursor: pointer;
            border-radius: 3px;
            overflow: hidden;
        }
        #progress {
            position: absolute;
            height: 100%;
            background: #ccc;
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 3px;
        }
        #progress-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            left: 0%;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        #progress-bar:hover #progress-handle { opacity: 1; }
        #volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 120px;
        }
        #volume-control span {
            margin-right: 10px;
            width: 80px;
            color: #aaa;
        }
        #playlist-toggle { min-width: 100px; }
        #current-time, #total-time {
            font-size: 0.8rem;
            color: #888;
            min-width: 40px;
            font-family: 'Courier New', monospace;
        }

        /* ä¸“æ³¨è®¡æ—¶åŒº */
        #time-display {
            margin: 10px 0;
            font-size: 1.8rem;
            color: #fff;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        /* æ’­æ”¾åˆ—è¡¨é¢æ¿ */
        #playlist-panel {
            position: absolute;
            bottom: 120px;
            right: 20px;
            width: 300px;
            max-height: 250px;
            background-color: rgba(0, 0, 0, 0.9);
            border: 1px solid #555;
            padding: 10px 15px;
            display: none;
            z-index: 101;
            overflow-y: auto;
        }
        #playlist-panel h4 {
            margin-bottom: 10px;
            color: #ccc;
            border-bottom: 1px solid #555;
            padding-bottom: 3px;
        }
        #playlist-panel > div:first-child {
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }
        .playlist-item {
            padding: 4px 5px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            transition: background 0.2s;
        }
        .playlist-item:hover { background-color: #222; }
        .playlist-item.active {
            color: #fff;
            background-color: #333;
        }
        .song-duration {
            color: #888;
            font-size: 0.8rem;
        }

        /* æ’­æ”¾æ¨¡å¼æŒ‰é’® */
        .play-mode-btn {
            width: 35px;
            height: 35px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            background-color: #222;
            border: 1px solid #555;
            margin: 0 2px;
        }
        .play-mode-btn:hover {
            background-color: #333;
            border-color: #777;
        }
        .play-mode-btn.active {
            background-color: #444;
            border-color: #fff;
            color: #fff;
        }
        .mode-controls {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            justify-content: center;
        }

        /* å¼¹çª—æç¤º */
        #customAlert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 2px solid #fff;
            padding: 25px 30px;
            width: 380px;
            max-width: 90vw;
            z-index: 9999;
            display: none;
        }
        #customAlert p {
            color: #fff;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 20px;
            text-align: center;
        }
        #customAlert button {
            display: block;
            margin: 0 auto;
            background: #333;
            color: #fff;
            border: 1px solid #fff;
            padding: 8px 20px;
        }
        #customAlert button:hover { background: #555; }

        /* éŸ³é¢‘å…ƒç´ éšè— */
        #background-music { display: none; }

        /* æ’­æ”¾/æš‚åœ/ä¸Šä¸€æ›²/ä¸‹ä¸€æ›² å›¾æ ‡æ ·å¼ */
        #play-pause-btn.play::before {
            content: '';
            display: inline-block;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 0 8px 14px;
            border-color: transparent transparent transparent #fff;
        }
        #play-pause-btn.pause::before {
            content: '';
            display: inline-block;
            width: 14px;
            height: 16px;
            background: linear-gradient(to right, #fff 35%, transparent 35%, transparent 65%, #fff 65%);
        }
        #prev-song {
            position: relative;
            width: 40px;
            height: 40px;
            padding: 0;
        }
        #prev-song::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 12px 8px 0;
            border-color: transparent #fff transparent transparent;
            margin-left: -6px;
        }
        #prev-song::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 12px 8px 0;
            border-color: transparent #fff transparent transparent;
            margin-left: 2px;
        }
        #next-song {
            position: relative;
            width: 40px;
            height: 40px;
            padding: 0;
        }
        #next-song::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 0 8px 12px;
            border-color: transparent transparent transparent #fff;
            margin-left: -2px;
        }
        #next-song::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 0 8px 12px;
            border-color: transparent transparent transparent #fff;
            margin-left: 6px;
        }

        /* æœ¬åœ°æ­Œæ›²åˆ é™¤æŒ‰é’® */
        .delete-song-btn {
            background: #ff6b6b !important;
            border: 1px solid #ff6b6b !important;
            padding: 2px 8px !important;
            font-size: 0.7rem !important;
            margin-left: auto;
        }
        .delete-song-btn:hover {
            background: #ff5252 !important;
            border-color: #ff5252 !important;
        }
    </style>
</head>
<body>
    <div id="background"></div>

    <!-- å¼¹çª—æç¤º -->
    <div id="customAlert">
        <p>Please manually select a song and environment sound to play.</p>
        <button id="closeAlert">Close</button>
    </div>

    <!-- éŸ³é¢‘å…ƒç´  -->
    <audio id="background-music"></audio>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <div id="left-panel" class="panel">
            <!-- ä¸“æ³¨è®¾ç½®åŒº -->
            <div class="control-section">
                <h3>concentration setting</h3>
                <div>
                    <label>Focus Times(minutes):</label>
                    <input type="number" id="focus-time" min="1" max="60" value="25">
                </div>
                <div>
                    <label>Resting Times(minutes):</label>
                    <input type="number" id="break-time" min="1" max="30" value="5">
                </div>
                <div id="time-display">25:00</div>
                <button id="start-focus">Start Focusing</button>
                <button id="pause-focus" disabled>Pause Focusing</button>
                <button id="stop-focus" disabled>Complete Focusing</button>
            </div>

            <!-- ç¯å¢ƒéŸ³æ§åˆ¶ -->
            <div class="control-section">
                <button id="toggle-environment">Background Sounds</button>
                <div id="environment-panel" class="environment-panel">
                    <div class="environment-panel-header">
                        <h3>Background Sounds (Select Multiple)</h3>
                        <button id="close-environment">Ã—</button>
                    </div>
                    <p class="multi-select-hint">Check multiple options to mix sounds (e.g., rain + fireplace)</p>
                    <div id="environment-items-container"></div>
                </div>
            </div>
        </div>

        <!-- ä¸­é—´åŒºåŸŸ -->
        <div id="middle-area"></div>
    </div>

    <!-- åº•éƒ¨æ’­æ”¾æ§åˆ¶æ  -->
    <div id="bottom-panel">
        <div id="music-controls">
            <!-- éŸ³é‡æ§åˆ¶ -->
            <div id="volume-control">
                <span>Volume:</span>
                <input type="range" id="music-volume" min="0" max="100" value="50">
            </div>

            <!-- ä¸­é—´æ’­æ”¾æ§åˆ¶ -->
            <div class="center-controls">
                <div id="song-info">
                    <div id="song-title">Select a song to play</div>
                </div>

                <div id="song-progress-container">
                    <div id="song-progress">
                        <span id="current-time">0:00</span>
                        <div id="progress-bar">
                            <div id="progress"></div>
                            <div id="progress-handle"></div>
                        </div>
                        <span id="total-time">0:00</span>
                    </div>

                    <!-- æ’­æ”¾æ¨¡å¼ -->
                    <div class="mode-controls">
                        <button id="play-mode-order" title="Play in order" class="play-mode-btn active">â‡„</button>
                        <button id="play-mode-loop" title="Loop playback" class="play-mode-btn">â†»</button>
                        <button id="play-mode-random" title="Shuffle play" class="play-mode-btn">â‡¢</button>
                    </div>
                </div>

                <!-- æ’­æ”¾æ§åˆ¶æŒ‰é’® -->
                <div class="control-buttons">
                    <button id="prev-song" title="Previous"></button>
                    <button id="play-pause-btn" title="Play" class="play"></button>
                    <button id="next-song" title="Next"></button>
                </div>
            </div>

            <!-- æ’­æ”¾åˆ—è¡¨åˆ‡æ¢ -->
            <button id="playlist-toggle">playlist</button>
        </div>
    </div>

    <!-- æ’­æ”¾åˆ—è¡¨é¢æ¿ -->
    <div id="playlist-panel">
        <h4>playlists</h4>
        <div style="margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;">
            <button id="upload-song-btn" style="width: 100%; margin-bottom: 10px;">Upload Local Song</button>
            <input type="file" id="file-input" accept="audio/*" style="display: none;">
            <div id="upload-status" style="font-size: 0.8rem; color: #888; text-align: center;"></div>
        </div>
        <div id="playlist-items"></div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€ç®¡ç†
        const state = {
            playMode: 'order',
            isFocusing: false,
            isPaused: false,
            focusTime: 25 * 60,
            breakTime: 5 * 60,
            currentTime: 0,
            timerInterval: null,
            selectedSong: null,
            currentSongIndex: 0,
            isMusicPlaying: false,
            currentSongType: 'default',
            // æ­Œæ›²åˆ—è¡¨ï¼ˆå·²ç§»é™¤æ— æ•ˆé¡¹ï¼‰
            songOptions: [
                { id: 'song1', title: 'Dream Dancer', duration: '4:07', src: 'music/Dream_Dancer.mp3' },
                { id: 'song2', title: 'Dark Music Box Waltz', duration: '2:48', src: 'music/Dark_Music_Box_Waltz.mp3' },
                { id: 'song3', title: 'Emotional Waltz', duration: '2:15', src: 'music/Emotional_Waltz.mp3' },
                { id: 'song4', title: "The Vampire's Ball", duration: '3:16', src: 'music/The_Vampire_s_Ball.mp3' },
                { id: 'song5', title: 'The_Goddess_Of_Tears_Legend', duration: '3:02', src: 'music/The_Goddess_Of Tearsï½Legendï½.mp3' },
                { id: 'song6', title: 'Ghost Waltz', duration: '2:08', src: 'music/Ghost_Waltz.mp3' },
                { id: 'song7', title: 'Secret Garden', duration: '3:18', src: 'music/Secret_Garden.mp3' },
                { id: 'song8', title: 'Spirit Of The Woods', duration: '5:00', src: 'music/Spirit_Of_The_Woods.mp3' },
                { id: 'song9', title: 'Patchwork_Staccato', duration: '4:18', src: 'music/Patchwork_Staccato.mp3' },
                { id: 'song10', title: 'green_to_blue', duration: '3:08', src: 'music/green_to_blue.mp3' },
                { id: 'song11', title: 'When_You_re_In_Love', duration: '7:20', src: 'music/When_You_re_In_Love.mp3' },
                { id: 'song12', title: 'i_m_tired_of_feeling_this_way', duration: '2:32', src: 'music/i_m_tired_of_feeling_this_way.mp3' },
                { id: 'song13', title: 'toki', duration: '1:48', src: 'music/toki.mp3' },
                { id: 'song14', title: 'leave_the_garden_lights_on_(demo)', duration: '1:42', src: 'music/leave_the_garden_lights_on_(demo).mp3' },
                { id: 'song15', title: 'BlueBerry_Room', duration: '1:44', src: 'music/BlueBerry_Room.mp3' },
                { id: 'song16', title: 'Agnes_Obel', duration: '4:18', src: 'music/Agnes_Obel.mp3' },
                { id: 'song17', title: 'ãƒãƒ«ã‚¿ãƒ¼ã‚¬ã‚¤ã‚¹ãƒˆ', duration: '4:18', src: 'music/ãƒãƒ«ã‚¿ãƒ¼ã‚¬ã‚¤ã‚¹ãƒˆ.mp3' },
                { id: 'song18', title: "The Mystic's Dream", duration: '7:51', src: 'music/The_Mystics_Dream.mp3' }
            ],
            // ç¯å¢ƒéŸ³åˆ—è¡¨ï¼ˆæ”¯æŒå¤šé€‰ï¼Œç®€åŒ–åç§°å’Œå›¾æ ‡ï¼‰
            environmentSoundOptions: [
                { id: 'The_fireplace_s_burn_from_kindling_to_embers', name: 'Fireplace Burn', volume: 50, audio: null, icon: 'ğŸ”¥' },
                { id: 'The_rain-lashed_forest', name: 'Rainy Forest', volume: 50, audio: null, icon: 'ğŸŒ§ï¸' },
                { id: 'Autumnal_wind_crisp_fallen_leaves_and_avian_murmurs', name: 'Autumn Wind', volume: 50, audio: null, icon: 'ğŸ‚' },
                { id: 'Gentle_wave_murmurs', name: 'Gentle Waves', volume: 50, audio: null, icon: 'ğŸŒŠ' },
                { id: 'Wind_chimes_in_the_gentle_breeze', name: 'Wind Chimes', volume: 50, audio: null, icon: 'ğŸ' },
                { id: 'writing_sounds', name: 'Writing Sounds', volume: 50, audio: null, icon: 'âœï¸' },
                { id: 'drawing_sounds', name: 'Drawing Sounds', volume: 50, audio: null, icon: 'ğŸ¨' },
            ],
            localSongs: [],
            localStorageKey: 'studyRoomLocalSongs'
        };

        // DOMå…ƒç´ è·å–
        const elements = {
            background: document.getElementById('background'),
            focusTimeInput: document.getElementById('focus-time'),
            breakTimeInput: document.getElementById('break-time'),
            timeDisplay: document.getElementById('time-display'),
            startFocusBtn: document.getElementById('start-focus'),
            pauseFocusBtn: document.getElementById('pause-focus'),
            stopFocusBtn: document.getElementById('stop-focus'),
            toggleEnvironmentBtn: document.getElementById('toggle-environment'),
            environmentPanel: document.getElementById('environment-panel'),
            musicVolume: document.getElementById('music-volume'),
            audioElement: document.getElementById('background-music'),
            middleArea: document.getElementById('middle-area'),
            prevSongBtn: document.getElementById('prev-song'),
            nextSongBtn: document.getElementById('next-song'),
            songTitle: document.getElementById('song-title'),
            currentTime: document.getElementById('current-time'),
            totalTime: document.getElementById('total-time'),
            progressBar: document.getElementById('progress-bar'),
            progress: document.getElementById('progress'),
            playlistToggle: document.getElementById('playlist-toggle'),
            playlistPanel: document.getElementById('playlist-panel'),
            playlistItems: document.getElementById('playlist-items'),
            playPauseBtn: document.getElementById('play-pause-btn'),
            customAlert: document.getElementById('customAlert'),
            closeAlert: document.getElementById('closeAlert'),
            environmentItemsContainer: document.getElementById('environment-items-container'),
            closeEnvironmentBtn: document.getElementById('close-environment')
        };

        // åˆ‡æ¢æ’­æ”¾æ¨¡å¼
        function switchPlayMode(mode) {
            state.playMode = mode;
            updatePlayModeButtons();
        }

        // æ›´æ–°æ’­æ”¾æ¨¡å¼æŒ‰é’®çŠ¶æ€
        function updatePlayModeButtons() {
            const orderBtn = document.getElementById('play-mode-order');
            const loopBtn = document.getElementById('play-mode-loop');
            const randomBtn = document.getElementById('play-mode-random');

            orderBtn.classList.remove('active');
            loopBtn.classList.remove('active');
            randomBtn.classList.remove('active');

            if (state.playMode === 'order') orderBtn.classList.add('active');
            else if (state.playMode === 'loop') loopBtn.classList.add('active');
            else if (state.playMode === 'random') randomBtn.classList.add('active');
        }

        // æ˜¾ç¤ºå¼¹çª—æç¤º
        function showBlackWhiteAlert(message = "Please manually select a song and environment sound to play.") {
            elements.customAlert.querySelector('p').textContent = message;
            elements.customAlert.style.display = 'block';
        }

        // å…³é—­å¼¹çª—æç¤º
        function closeBlackWhiteAlert() {
            elements.customAlert.style.display = 'none';
        }

        // åˆ‡æ¢ç¯å¢ƒéŸ³é¢æ¿æ˜¾ç¤º/éšè—
        function toggleEnvironmentPanel() {
            elements.environmentPanel.classList.toggle('show');
        }

        // ä¿å­˜æœ¬åœ°æ­Œæ›²åˆ°localStorage
        function saveLocalSongs() {
            try {
                localStorage.setItem(state.localStorageKey, JSON.stringify(state.localSongs));
            } catch (error) {
                console.error('Failed to save local songs:', error);
                showBlackWhiteAlert('Save failed: ' + error.message);
            }
        }

        // ä»localStorageåŠ è½½æœ¬åœ°æ­Œæ›²
        function loadLocalSongs() {
            try {
                const saved = localStorage.getItem(state.localStorageKey);
                if (saved) state.localSongs = JSON.parse(saved);
            } catch (error) {
                console.error('Failed to load local songs:', error);
                state.localSongs = [];
            }
        }

        // åˆå§‹åŒ–æœ¬åœ°æ­Œæ›²ä¸Šä¼ åŠŸèƒ½
        function initUploadFeature() {
            const uploadBtn = document.getElementById('upload-song-btn');
            const fileInput = document.getElementById('file-input');
            const uploadStatus = document.getElementById('upload-status');

            uploadBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);

            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.type.startsWith('audio/')) {
                    uploadStatus.textContent = 'Error: Please select an audio file';
                    uploadStatus.style.color = '#ff6b6b';
                    return;
                }

                if (file.size > 20 * 1024 * 1024) {
                    uploadStatus.textContent = 'Error: File size must not exceed 20 MB.';
                    uploadStatus.style.color = '#ff6b6b';
                    return;
                }

                uploadStatus.textContent = 'Uploading...';
                uploadStatus.style.color = '#888';

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const songData = {
                            id: 'local_' + Date.now(),
                            title: file.name.replace(/\.[^/.]+$/, ""),
                            duration: 'Unknown',
                            src: e.target.result,
                            isLocal: true,
                            fileName: file.name
                        };

                        state.localSongs.push(songData);
                        saveLocalSongs();
                        updatePlaylistForCurrentSong(state.currentSongIndex);

                        uploadStatus.textContent = 'Upload successful!';
                        uploadStatus.style.color = '#6bff6b';
                        setTimeout(() => uploadStatus.textContent = '', 3000);
                    } catch (error) {
                        console.error('Failed to process uploaded file:', error);
                        uploadStatus.textContent = 'Upload failed: ' + error.message;
                        uploadStatus.style.color = '#ff6b6b';
                    }
                };

                reader.onerror = function() {
                    uploadStatus.textContent = 'Failed to read the file';
                    uploadStatus.style.color = '#ff6b6b';
                };

                reader.readAsDataURL(file);
                event.target.value = '';
            }
        }

        // åˆ é™¤æœ¬åœ°æ­Œæ›²
        function deleteLocalSong(songId) {
            if (confirm('Are you sure you want to delete this song?')) {
                state.localSongs = state.localSongs.filter(song => song.id !== songId);
                saveLocalSongs();

                if (state.selectedSong && state.selectedSong.id === songId) {
                    elements.audioElement.pause();
                    elements.audioElement.src = '';
                    state.isMusicPlaying = false;
                    updatePlayPauseButton();
                    elements.songTitle.textContent = 'Select a song to play';
                }

                updatePlaylistForCurrentSong(state.currentSongIndex);
            }
        }

        // åˆå§‹åŒ–æ’­æ”¾åˆ—è¡¨
        function initPlaylist() {
            loadLocalSongs();
            const playlist = elements.playlistItems;
            playlist.innerHTML = '';
            const allSongs = [...state.songOptions, ...state.localSongs];
            let displaySongs = state.playMode === 'random' 
                ? allSongs.sort(() => Math.random() - 0.5) 
                : [...allSongs];
            
            displaySongs.forEach((song, index) => {
                const item = createPlaylistItem(song, index);
                playlist.appendChild(item);
            });
            
            return displaySongs;
        }

        // åˆ›å»ºæ’­æ”¾åˆ—è¡¨é¡¹
        function createPlaylistItem(song, index) {
            const item = document.createElement('div');
            item.className = 'playlist-item';
            item.dataset.index = index;

            const deleteBtn = song.isLocal ?
                `<button class="delete-song-btn" data-song-id="${song.id}">Delete</button>` :
                '';

            item.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                    <div style="display: flex; flex-direction: column;">
                        <span>${song.title}</span>
                        ${song.isLocal ? '<span style="font-size: 0.7rem; color: #6bff6b;">[Local]</span>' : ''}
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="song-duration">${song.duration}</span>
                        ${deleteBtn}
                    </div>
                </div>
            `;

            item.addEventListener('click', (e) => {
                if (!e.target.classList.contains('delete-song-btn')) playSong(index);
            });

            if (song.isLocal) {
                const deleteBtn = item.querySelector('.delete-song-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteLocalSong(song.id);
                });
            }

            return item;
        }

        // æ›´æ–°æ’­æ”¾åˆ—è¡¨é€‰ä¸­çŠ¶æ€
        function updatePlaylistForCurrentSong(currentIndex) {
            const playlist = elements.playlistItems;
            playlist.innerHTML = '';
            const allSongs = [...state.songOptions, ...state.localSongs];
            let displaySongs = state.playMode === 'random' 
                ? allSongs.sort(() => Math.random() - 0.5) 
                : [...allSongs];
            
            displaySongs.forEach((song, index) => {
                const item = createPlaylistItem(song, index);
                if (song.id === allSongs[currentIndex]?.id) item.classList.add('active');
                playlist.appendChild(item);
            });
            
            return displaySongs;
        }

        // éŸ³é¢‘åŠ è½½çŠ¶æ€æ§åˆ¶ï¼ˆä¿®å¤æ’­æ”¾ä¸­æ–­é”™è¯¯ï¼‰
        let isLoadingAudio = false;

        // æ’­æ”¾æ­Œæ›²
        async function playSong(index) {
            if (isLoadingAudio) {
                elements.audioElement.pause();
                elements.audioElement.src = '';
                isLoadingAudio = false;
            }

            const allSongs = [...state.songOptions, ...state.localSongs];
            if (!allSongs[index] || !allSongs[index].src) {
                showBlackWhiteAlert('Invalid song path, please check the file.');
                return;
            }

            isLoadingAudio = true;
            const song = allSongs[index];
            state.currentSongIndex = index;
            state.selectedSong = song;
            state.currentSongType = song.isLocal ? 'local' : 'default';
            elements.songTitle.textContent = song.title + (song.isLocal ? ' [Local Music]' : '');
            updatePlaylistForCurrentSong(index);

            // é‡ç½®è¿›åº¦æ¡
            elements.progress.style.width = '0%';
            elements.currentTime.textContent = '0:00';

            try {
                // æ¸…é™¤æ—§äº‹ä»¶ç›‘å¬
                elements.audioElement.pause();
                elements.audioElement.removeEventListener('timeupdate', updateProgress);
                elements.audioElement.removeEventListener('loadedmetadata', handleLoadedMetadata);
                elements.audioElement.removeEventListener('ended', handleAudioEnded);

                // è®¾ç½®æ–°éŸ³é¢‘æº
                elements.audioElement.src = song.src;
                elements.audioElement.volume = elements.musicVolume.value / 100;

                // æ·»åŠ æ–°äº‹ä»¶ç›‘å¬
                elements.audioElement.addEventListener('loadedmetadata', handleLoadedMetadata);
                elements.audioElement.addEventListener('ended', handleAudioEnded);

                // é‡ç½®æ’­æ”¾çŠ¶æ€
                state.isMusicPlaying = false;
                updatePlayPauseButton();
                isLoadingAudio = false;
            } catch (error) {
                console.error('Playback initialization failed:', error);
                showBlackWhiteAlert('Failed to initialize playback. Please select the song again.');
                state.isMusicPlaying = false;
                updatePlayPauseButton();
                isLoadingAudio = false;
            }
        }

        // éŸ³é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆå¤„ç†
        function handleLoadedMetadata() {
            if (elements.audioElement.duration && !isNaN(elements.audioElement.duration)) {
                elements.totalTime.textContent = formatTime(elements.audioElement.duration);
                updateProgress();
            }
            elements.audioElement.addEventListener('timeupdate', updateProgress);
        }

        // éŸ³é¢‘æ’­æ”¾ç»“æŸå¤„ç†
        function handleAudioEnded() {
            state.isMusicPlaying = false;
            updatePlayPauseButton();
            elements.songTitle.textContent = 'Song ended. Select another song';
        }

        // åˆ‡æ¢æ’­æ”¾/æš‚åœ
        async function togglePlayPause() {
            if (!elements.audioElement.src) {
                showBlackWhiteAlert('Please select a song first from the playlist');
                return;
            }

            state.isMusicPlaying ? pauseMusic() : await playMusic();
        }

        // æ’­æ”¾éŸ³é¢‘
        async function playMusic() {
            if (!elements.audioElement.src) {
                showBlackWhiteAlert('Please select a song first from the playlist');
                return;
            }

            try {
                await elements.audioElement.play();
                state.isMusicPlaying = true;
                updatePlayPauseButton();
            } catch (error) {
                console.error('Playback failed:', error);
                showBlackWhiteAlert('Playback failed. Please try selecting the song again.');
            }
        }

        // æš‚åœéŸ³é¢‘
        function pauseMusic() {
            elements.audioElement.pause();
            state.isMusicPlaying = false;
            updatePlayPauseButton();
        }

        // æ›´æ–°æ’­æ”¾/æš‚åœæŒ‰é’®æ ·å¼
        function updatePlayPauseButton() {
            if (state.isMusicPlaying) {
                elements.playPauseBtn.className = 'pause';
                elements.playPauseBtn.title = 'Pause';
            } else {
                elements.playPauseBtn.className = 'play';
                elements.playPauseBtn.title = 'Play';
            }
        }

        // æ’­æ”¾ä¸Šä¸€æ›²
        function playPreviousSong() {
            const allSongs = [...state.songOptions, ...state.localSongs];
            if (allSongs.length === 0) return;

            let prevIndex;
            switch (state.playMode) {
                case 'order':
                    prevIndex = state.currentSongIndex - 1;
                    if (prevIndex < 0) {
                        showBlackWhiteAlert('This is the first song');
                        return;
                    }
                    break;
                case 'loop':
                    prevIndex = state.currentSongIndex - 1 < 0 ? allSongs.length - 1 : state.currentSongIndex - 1;
                    break;
                case 'random':
                    prevIndex = Math.floor(Math.random() * allSongs.length);
                    break;
                default:
                    prevIndex = state.currentSongIndex - 1 < 0 ? allSongs.length - 1 : state.currentSongIndex - 1;
            }

            playSong(prevIndex);
        }

        // æ’­æ”¾ä¸‹ä¸€æ›²
        function playNextSong() {
            const allSongs = [...state.songOptions, ...state.localSongs];
            if (allSongs.length === 0) return;

            let nextIndex;
            switch (state.playMode) {
                case 'order':
                    nextIndex = state.currentSongIndex + 1;
                    if (nextIndex >= allSongs.length) {
                        showBlackWhiteAlert('This is the last song');
                        return;
                    }
                    break;
                case 'loop':
                    nextIndex = (state.currentSongIndex + 1) % allSongs.length;
                    break;
                case 'random':
                    nextIndex = Math.floor(Math.random() * allSongs.length);
                    break;
                default:
                    nextIndex = state.currentSongIndex + 1;
            }

            playSong(nextIndex);
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
            if (elements.audioElement.duration && !isNaN(elements.audioElement.duration)) {
                const currentTime = elements.audioElement.currentTime;
                const duration = elements.audioElement.duration;
                const progressPercent = (currentTime / duration) * 100;

                elements.progress.style.width = `${progressPercent}%`;
                document.getElementById('progress-handle').style.left = `${progressPercent}%`;
                elements.currentTime.textContent = formatTime(currentTime);
                elements.totalTime.textContent = formatTime(duration);
            }
        }

        // æ—¶é—´æ ¼å¼åŒ–
        function formatTime(seconds) {
            if (isNaN(seconds)) return "0:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        // è¿›åº¦æ¡ç‚¹å‡»æ§åˆ¶
        function setupProgressBarClick() {
            elements.progressBar.addEventListener('click', (e) => {
                if (elements.audioElement.duration) {
                    const clickPosition = e.offsetX / elements.progressBar.offsetWidth;
                    elements.audioElement.currentTime = clickPosition * elements.audioElement.duration;
                    updateProgress();
                }
            });
        }

        // è¿›åº¦æ¡æ‹–åŠ¨æ§åˆ¶
        function setupProgressBarDrag() {
            let isDragging = false;

            elements.progressBar.addEventListener('mousedown', (e) => {
                isDragging = true;
                handleProgressBarClick(e);
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging && elements.audioElement.duration) {
                    const rect = elements.progressBar.getBoundingClientRect();
                    const clickPosition = (e.clientX - rect.left) / rect.width;
                    const newTime = Math.max(0, Math.min(1, clickPosition)) * elements.audioElement.duration;
                    elements.audioElement.currentTime = newTime;
                    updateProgress();
                }
            });

            document.addEventListener('mouseup', () => isDragging = false);
        }

        // è¿›åº¦æ¡ç‚¹å‡»å¤„ç†
        function handleProgressBarClick(e) {
            if (elements.audioElement.duration) {
                const rect = elements.progressBar.getBoundingClientRect();
                const clickPosition = (e.clientX - rect.left) / rect.width;
                const newTime = Math.max(0, Math.min(1, clickPosition)) * elements.audioElement.duration;
                elements.audioElement.currentTime = newTime;
                updateProgress();
            }
        }

        // è®¾ç½®èƒŒæ™¯å›¾
        function setBackground(mode) {
            const gifUrls = {
                focus: 'images/studying.gif',
                rest: 'images/resting.gif'
            };
            elements.background.style.backgroundImage = `url(${gifUrls[mode]})`;
        }

        // åˆå§‹åŒ–ç¯å¢ƒéŸ³é¢æ¿ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
        function initEnvironmentPanel() {
            const container = elements.environmentItemsContainer;
            container.innerHTML = '';

            state.environmentSoundOptions.forEach(sound => {
                const soundElement = document.createElement('div');
                soundElement.className = 'environment-item';
                soundElement.dataset.soundId = sound.id;

                // ç‚¹å‡»æ•´ä¸ªé¡¹åˆ‡æ¢é€‰ä¸­çŠ¶æ€
                soundElement.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('env-volume')) {
                        const checkbox = soundElement.querySelector('.env-checkbox');
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });

                soundElement.innerHTML = `
                    <div class="sound-header">
                        <input type="checkbox" class="env-checkbox" id="env-${sound.id}">
                        <label for="env-${sound.id}" class="env-label">
                            <span class="env-icon">${sound.icon}</span>
                            <span class="env-name">${sound.name}</span>
                        </label>
                    </div>
                    <div class="volume-control">
                        <input type="range" class="env-volume" data-sound="${sound.id}" min="0" max="100" value="${sound.volume}">
                        <span class="volume-value">${sound.volume}%</span>
                    </div>
                `;
                container.appendChild(soundElement);

                // åˆå§‹åŒ–ç¯å¢ƒéŸ³éŸ³é¢‘å¯¹è±¡ï¼ˆç‹¬ç«‹æ’­æ”¾ï¼Œæ”¯æŒå¤šéŸ³è½¨ï¼‰
                sound.audio = new Audio(`sounds/${sound.id}.mp3`);
                sound.audio.loop = true;
                sound.audio.volume = sound.volume / 100;

                // åŠ è½½é”™è¯¯å¤„ç†
                sound.audio.addEventListener('error', function(e) {
                    console.error(`Failed to load: ${sound.name}`, e);
                    showBlackWhiteAlert(`Could not load "${sound.name}". Check if the file exists.`);
                });

                // å¤é€‰æ¡†åˆ‡æ¢äº‹ä»¶ï¼ˆæ ¸å¿ƒå¤šé€‰é€»è¾‘ï¼‰
                const checkbox = soundElement.querySelector('.env-checkbox');
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        playEnvironmentSound(sound);
                        soundElement.classList.add('active');
                    } else {
                        stopEnvironmentSound(sound);
                        soundElement.classList.remove('active');
                    }
                });

                // éŸ³é‡è°ƒèŠ‚ï¼ˆç‹¬ç«‹æ§åˆ¶ï¼‰
                const volumeSlider = soundElement.querySelector('.env-volume');
                const volumeValue = soundElement.querySelector('.volume-value');
                volumeSlider.addEventListener('input', (e) => {
                    sound.volume = e.target.value;
                    volumeValue.textContent = `${sound.volume}%`;
                    if (sound.audio) sound.audio.volume = sound.volume / 100;
                });
            });
        }

        // æ’­æ”¾ç¯å¢ƒéŸ³ï¼ˆæ”¯æŒå¤šéŸ³è½¨åŒæ—¶æ’­æ”¾ï¼‰
        function playEnvironmentSound(sound) {
            if (sound.audio) {
                if (!sound.audio.paused) {
                    sound.audio.currentTime = 0; // å·²æ’­æ”¾æ—¶é‡ç½®åˆ°å¼€å¤´
                } else {
                    // å¤„ç†æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾é™åˆ¶
                    sound.audio.play().catch(e => {
                        console.warn(`Auto-play blocked for ${sound.name}`, e);
                        showBlackWhiteAlert(`Click "Play" again to enable "${sound.name}" (browser policy).`);
                    });
                }
            }
        }

        // åœæ­¢ç¯å¢ƒéŸ³
        function stopEnvironmentSound(sound) {
            if (sound.audio) {
                sound.audio.pause();
                sound.audio.currentTime = 0; // é‡ç½®åˆ°å¼€å¤´
            }
        }

        // å¼€å§‹ä¸“æ³¨
        function startFocus() {
            if (state.isFocusing && !state.isPaused) return;

            state.isFocusing = true;
            state.isPaused = false;
            state.focusTime = parseInt(elements.focusTimeInput.value) * 60;
            state.breakTime = parseInt(elements.breakTimeInput.value) * 60;
            state.currentTime = state.focusTime;

            updateTimeDisplay();
            setBackground('focus');
            elements.startFocusBtn.disabled = true;
            elements.pauseFocusBtn.disabled = false;
            elements.stopFocusBtn.disabled = false;
            elements.pauseFocusBtn.textContent = 'Pause Focus';

            if (state.timerInterval) clearInterval(state.timerInterval);
            state.timerInterval = setInterval(updateTimer, 1000);
        }

        // æš‚åœä¸“æ³¨
        function pauseFocus() {
            if (!state.isFocusing || state.isPaused) return;

            state.isPaused = true;
            clearInterval(state.timerInterval);
            elements.pauseFocusBtn.textContent = 'Continue Focus';
        }

        // æ¢å¤ä¸“æ³¨
        function resumeFocus() {
            if (!state.isFocusing || !state.isPaused) return;

            state.isPaused = false;
            state.timerInterval = setInterval(updateTimer, 1000);
            elements.pauseFocusBtn.textContent = 'Pause Focus';
        }

        // ç»“æŸä¸“æ³¨
        function stopFocus() {
            state.isFocusing = false;
            state.isPaused = false;
            clearInterval(state.timerInterval);
            setBackground('rest');
            elements.startFocusBtn.disabled = false;
            elements.pauseFocusBtn.disabled = true;
            elements.stopFocusBtn.disabled = true;
            elements.pauseFocusBtn.textContent = 'Pause Focus';
            const focusMinutes = parseInt(elements.focusTimeInput.value);
            elements.timeDisplay.textContent = `${focusMinutes.toString().padStart(2, '0')}:00`;
        }

        // æ›´æ–°è®¡æ—¶å™¨
        function updateTimer() {
            if (state.isPaused) return;

            if (state.currentTime <= 0) {
                if (state.isFocusing) {
                    state.isFocusing = false;
                    state.currentTime = state.breakTime;
                    setBackground('rest');
                    showBlackWhiteAlert('Focus session completeâ€”time for a break.');
                } else {
                    stopFocus();
                    showBlackWhiteAlert('Break time is over.');
                }
                return;
            }

            state.currentTime--;
            updateTimeDisplay();
        }

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTimeDisplay() {
            const minutes = Math.floor(state.currentTime / 60);
            const seconds = state.currentTime % 60;
            elements.timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // åˆå§‹åŒ–æ‰€æœ‰äº‹ä»¶ç›‘å¬
        function initEventListeners() {
            // ä¸“æ³¨è®¡æ—¶æ§åˆ¶
            elements.startFocusBtn.addEventListener('click', startFocus);
            elements.pauseFocusBtn.addEventListener('click', () => {
                state.isPaused ? resumeFocus() : pauseFocus();
            });
            elements.stopFocusBtn.addEventListener('click', stopFocus);

            // ç¯å¢ƒéŸ³é¢æ¿æ§åˆ¶
            elements.toggleEnvironmentBtn.addEventListener('click', toggleEnvironmentPanel);
            elements.closeEnvironmentBtn.addEventListener('click', () => {
                elements.environmentPanel.classList.remove('show');
            });
            elements.environmentPanel.addEventListener('click', (e) => {
                if (e.target === elements.environmentPanel) elements.environmentPanel.classList.remove('show');
            });

            // æ’­æ”¾æ¨¡å¼æ§åˆ¶
            document.getElementById('play-mode-order').addEventListener('click', () => switchPlayMode('order'));
            document.getElementById('play-mode-loop').addEventListener('click', () => switchPlayMode('loop'));
            document.getElementById('play-mode-random').addEventListener('click', () => switchPlayMode('random'));

            // éŸ³ä¹æ§åˆ¶
            elements.playPauseBtn.addEventListener('click', togglePlayPause);
            elements.prevSongBtn.addEventListener('click', playPreviousSong);
            elements.nextSongBtn.addEventListener('click', playNextSong);
            elements.musicVolume.addEventListener('input', () => {
                elements.audioElement.volume = elements.musicVolume.value / 100;
            });

            // è¿›åº¦æ¡æ§åˆ¶
            setupProgressBarClick();
            setupProgressBarDrag();

            // æ’­æ”¾åˆ—è¡¨æ§åˆ¶
            elements.playlistToggle.addEventListener('click', () => {
                elements.playlistPanel.style.display = elements.playlistPanel.style.display === 'block' ? 'none' : 'block';
            });

            // å¼¹çª—æ§åˆ¶
            elements.closeAlert.addEventListener('click', closeBlackWhiteAlert);
            elements.customAlert.addEventListener('click', (e) => {
                if (e.target === elements.customAlert) closeBlackWhiteAlert();
            });

            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space') {
                    e.preventDefault();
                    togglePlayPause();
                } else if (e.code === 'ArrowLeft') {
                    e.preventDefault();
                    playPreviousSong();
                } else if (e.code === 'ArrowRight') {
                    e.preventDefault();
                    playNextSong();
                } else if (e.code === 'Escape') {
                    elements.environmentPanel.classList.remove('show');
                    elements.playlistPanel.style.display = 'none';
                    closeBlackWhiteAlert();
                }
            });

            // ç¦æ­¢æ‹–æ‹½
            document.addEventListener('dragstart', (e) => e.preventDefault());
        }

        // åˆå§‹åŒ–åº”ç”¨
        async function init() {
            setBackground('rest');
            initEnvironmentPanel();
            initEventListeners();
            initUploadFeature();
            loadLocalSongs();

            updatePlayModeButtons();
            initPlaylist();
            showBlackWhiteAlert("Please manually select a song and environment sound to play.");
        }

        // å¯åŠ¨åº”ç”¨
        window.addEventListener('load', init);
    </script>
</body>
</html>
